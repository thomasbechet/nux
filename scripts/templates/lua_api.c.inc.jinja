#include "internal.h"

{% set checkmap = {
    "nux_i8_t": "luaL_checkinteger",
    "nux_u8_t": "luaL_checkinteger",
    "nux_i32_t": "luaL_checkinteger",
    "nux_u32_t": "luaL_checkinteger",
    "nux_f32_t": "luaL_checknumber",
} %}

{% set retmap = {
    "nux_i8_t": "lua_pushinteger",
    "nux_u8_t": "lua_pushinteger",
    "nux_i32_t": "lua_pushinteger",
    "nux_u32_t": "lua_pushinteger",
    "nux_f32_t": "lua_pushnumber",
    "nux_status_t": "lua_pushinteger"
} %}

{% for module, functions in modules.items() %}
{% for function in functions %}
{% if not function.hasptr %}
static int l_{{ module }}_{{ function.name }}(lua_State *L)
{
    lua_rawgeti(L, LUA_REGISTRYINDEX, 1);
    nux_env_t *env = lua_touserdata(L, -1);
    {%- for arg in function.args -%}
        {{ arg.typename }} {{ arg.name }} = {{ checkmap.get(arg.typename, "luaL_checkinteger") }}(L, {{ loop.index }});
    {%- endfor -%}
    {% if function.returntype != "void" %}
        {{ function.returntype }} ret =
    {% endif %}
    {{ "nux_" + module if module != "base" else "nux" }}_{{ function.name }}(env
    {%- for arg in function.args -%}
        , {{ arg.name }}
    {%- endfor -%}
    );
    {% if function.returntype != "void" %}
        lua_pushinteger(L, ret);
        return 1;
    {% else %}
        return 0;
    {% endif %}
}
{% endif %}
{%- endfor %}
{% endfor %}

{% for module, functions in modules.items() %}
static const struct luaL_Reg lib_{{ module }}[] = {
{% for function in functions %}
{% if not function.hasptr %}
    { "{{ function.name }}", l_{{ module }}_{{ function.name }} },
{% endif %}
{%- endfor %}
    { NUX_NULL, NUX_NULL }
};
{% endfor %}

nux_status_t nux_register_lua(nux_instance_t *inst)
{
    lua_newtable(inst->L);
{% for module in modules.keys() %}
    lua_newtable(inst->L);
    luaL_setfuncs(inst->L, lib_{{ module }}, 0);
    lua_setfield(inst->L, -2, "{{ module }}");
{% endfor %}
    lua_setglobal(inst->L, "nux");
    return NUX_SUCCESS;
}
